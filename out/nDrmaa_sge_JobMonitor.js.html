<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: nDrmaa/sge/JobMonitor.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: nDrmaa/sge/JobMonitor.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as sge from "./sge-cli";
import * as Exception from "../Exceptions";
import Job from "../Job";
import {EventEmitter} from "events";

let _refreshInterval = 1000;                    // Refresh interval for the monitor
/**
 * Class for monitoring jobs' completion.
 * @extends EventEmitter
 */
class JobMonitor extends EventEmitter{
  /**
   * Monitor initialization.
   */
  constructor(){
    super();
    this.setMaxListeners(0);                    // Set to infinity the max number of listeners for this EventEmitter.
    this.JobsQueue = [];                        // List of jobs to monitor
    this.startMonitor();                        // Starts monitoring
    console.log("Job Monitor started");
  }

  /**
   * Registers a list of jobs to monitor for completion status.
   * @param {Job[]} jobs - List of jobs to monitor.
   * @throws {module:nDrmaaExceptions.InvalidArgumentException} InvalidArgumentException - The array passed does not
   *    contain elements of class Job
   */
  registerJobs(jobs){
    jobs.forEach((job) => {
      if(!(job instanceof Job))
        throw new Exception.InvalidArgumentException("Function registerJob(jobs): argument 'jobs' must be an array of " +
          " elements of class Job");
      this.JobsQueue.push(job);
    });
  }

  /**
   * Starts monitoring.
   */
  startMonitor(){
    this.monitor = setInterval(() => {
      this.getJobs();
    }, _refreshInterval)
  }

  /**
   * Fires when a job has completed its execution.
   * Returns the Id of the completed job.
   *
   * @event JobCompleted
   * @type {number}
   */

  /**
   * Fires when a job has encountered an error and could not complete its execution.
   * Returns the Id of the job in error.
   *
   * @event JobError
   * @type {number}
   */

  /**
   * Fires when the invocation of command qstat could not be executed due to some error.
   * Returns the error reason.
   *
   * @event qstatError
   * @type {*}
   */

  /**
   * Get the list of currently active jobs from qstat, and emit event according to the completion status of each
   * registered job: if a job is registered but does not show up on the list returned by qstat, it emits a "JobCompleted"
   * event with the id of the job as a message; otherwise, if it appears on the list but its status is marked as "ERROR",
   * emit the event "JobError" along with the id of the job.
   * @fires JobCompleted
   * @fires JobError
   * @fires qstatError
   */
  getJobs(){
    if(this.JobsQueue.length>0) {
      sge.qstat().then((qstatJobs) => {
        this.JobsQueue.forEach((job) => {

          let jobId = job.jobId;

          // The job does not appear on the list returned by qstat -> COMPLETED
          if (!qstatJobs[jobId]) {
            this.JobsQueue.splice(this.JobsQueue.indexOf(job), 1);
            this.emit("JobCompleted", jobId);
          }
          // The job does not appear on the list returned by qstat -> check if it is in error state
          else {
            let jobStatus = job.isJobArray ? _parseJobArrayStatus(qstatJobs[jobId])
              : _parseJobStatus(qstatJobs[jobId]["jobState"]);

            if (jobStatus === "ERROR") {
              this.JobsQueue.splice(this.JobsQueue.indexOf(job), 1);
              this.emit("JobError", jobId);
            }
          }
        });
      }, (err) => {
        this.emit("qstatError", err);
      });
    }
  }

}


/**
 * Helper method for retrieving the status of a job
 * @param {string} jobStatus - raw status parsed from qstat
 * @returns {string} - a more explicative status.
 * @private
 */
function _parseJobStatus(jobStatus){
  switch(jobStatus){
    case "qw":
      return "QUEUED";
      break;

    case "hqw":
    case "hRqw":
    case "hRwq":
      return "ON_HOLD";
      break;

    case "r":
    case "t":
    case "Rr":
    case "Rt":
      return "RUNNING";
      break;

    case "s":
    case "ts":
    case "S":
    case "tS":
    case "T":
    case "tT":
    case "Rs":
    case "Rts":
    case "RS":
    case "RtS":
    case "RT":
    case "RtT":
      return "SUSPENDED";
      break;

    case "Eqw":
    case "Ehqw":
    case "EhRqw":
      return "ERROR";
      break;
  }
}

/**
 * Function to determine whether an array job is in error state. It suffices that only one task of the array job
 * is in error state for the whole job to be marked as in error.
 * @param {Object} jobArrayTasks - list of tasks of the array job retrieved from qstat
 * @returns {string} - "ERROR" if the array job is in error state, "UNDETERMINED" otherwise
 * @private
 */
function _parseJobArrayStatus(jobArrayTasks){
  let jobStatus = "UNDETERMINED";
  for(let taskId in jobArrayTasks) {
    if (jobArrayTasks.hasOwnProperty(taskId)) {
      let taskStatus = _parseJobStatus(jobArrayTasks[taskId].jobState);
      if(taskStatus === "ERROR") return "ERROR";
    }
  }
  return jobStatus;
}

export default JobMonitor</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-nDrmaaExceptions.html">nDrmaaExceptions</a></li><li><a href="module-scheduler_monitors.html">scheduler/monitors</a></li><li><a href="module-sge-cli.html">sge-cli</a></li></ul><h3>Classes</h3><ul><li><a href="Database.html">Database</a></li><li><a href="Job.html">Job</a></li><li><a href="JobInfo.html">JobInfo</a></li><li><a href="JobInfoImpl.html">JobInfoImpl</a></li><li><a href="JobMonitor.html">JobMonitor</a></li><li><a href="JobTemplate.html">JobTemplate</a></li><li><a href="module-nDrmaaExceptions.AlreadyActiveSessionException.html">AlreadyActiveSessionException</a></li><li><a href="module-nDrmaaExceptions.DrmsInitException.html">DrmsInitException</a></li><li><a href="module-nDrmaaExceptions.ExitTimeoutException.html">ExitTimeoutException</a></li><li><a href="module-nDrmaaExceptions.InvalidArgumentException.html">InvalidArgumentException</a></li><li><a href="module-nDrmaaExceptions.InvalidSessionException.html">InvalidSessionException</a></li><li><a href="module-nDrmaaExceptions.NoActiveSessionException.html">NoActiveSessionException</a></li><li><a href="module-nDrmaaExceptions.UnsupportedAttributeException.html">UnsupportedAttributeException</a></li><li><a href="scheduler_SchedulerManager.html">scheduler/SchedulerManager</a></li><li><a href="Session.html">Session</a></li><li><a href="SessionImpl.html">SessionImpl</a></li><li><a href="SessionManager.html">SessionManager</a></li><li><a href="SessionManagerImpl.html">SessionManagerImpl</a></li><li><a href="Version.html">Version</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:JobCompleted">JobCompleted</a></li><li><a href="global.html#event:JobError">JobError</a></li><li><a href="global.html#event:qstatError">qstatError</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-SchedulerManager.html">SchedulerManager</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_getArrayJobStatus">_getArrayJobStatus</a></li><li><a href="global.html#_parseJobArrayStatus">_parseJobArrayStatus</a></li><li><a href="global.html#_parseJobStatus">_parseJobStatus</a></li><li><a href="global.html#_removeListeners">_removeListeners</a></li><li><a href="global.html#generateUUIDV4">generateUUIDV4</a></li><li><a href="global.html#HOLD">HOLD</a></li><li><a href="global.html#JOB_IDS_SESSION_ALL">JOB_IDS_SESSION_ALL</a></li><li><a href="global.html#JOBTYPE">JOBTYPE</a></li><li><a href="global.html#RELEASE">RELEASE</a></li><li><a href="global.html#RESUME">RESUME</a></li><li><a href="global.html#SUSPEND">SUSPEND</a></li><li><a href="global.html#TERMINATE">TERMINATE</a></li><li><a href="global.html#TIMEOUT_WAIT_FOREVER">TIMEOUT_WAIT_FOREVER</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Oct 09 2017 14:19:28 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
